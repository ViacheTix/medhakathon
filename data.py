import pandas as pd
import json
import os

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É—Ç–µ–π
INPUT_DIR = 'data'
OUTPUT_DIR = 'output'  # –°—é–¥–∞ –ø–æ–ª–æ–∂–∏–º –≥–æ—Ç–æ–≤—ã–µ JSON –¥–ª—è –∞–≥–µ–Ω—Ç–∞

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –Ω–µ—Ç
os.makedirs(OUTPUT_DIR, exist_ok=True)

def load_data():
    """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö –∫–æ–ª–æ–Ω–æ–∫"""
    print("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...")
    
    # 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–≥–Ω–æ–∑—ã
    df_diag = pd.read_csv(os.path.join(INPUT_DIR, '–¥–∞–Ω–Ω—ã–µ_–¥–∏–∞–≥–Ω–æ–∑—ã.csv'))
    
    # 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
    df_patients = pd.read_csv(os.path.join(INPUT_DIR, '–¥–∞–Ω–Ω—ã–µ_–ø–∞—Ü–∏–µ–Ω—Ç–æ–≤.csv'))
    
    # 3. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ—Ü–µ–ø—Ç—ã
    # –í–Ω–∏–º–∞–Ω–∏–µ: pandas –ø–µ—Ä–µ–∏–º–µ–Ω—É–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∫–æ–ª–æ–Ω–∫–∏. 
    # id_–ø–∞—Ü–∏–µ–Ω—Ç–∞ (1) -> id_—Ä–µ—Ü–µ–ø—Ç–∞ (–ø–æ –ª–æ–≥–∏–∫–µ), id_–ø–∞—Ü–∏–µ–Ω—Ç–∞.1 -> id_–ø–∞—Ü–∏–µ–Ω—Ç–∞ (—Å–≤—è–∑—å)
    df_recipes = pd.read_csv(os.path.join(INPUT_DIR, '–¥–∞–Ω–Ω—ã–µ_—Ä–µ—Ü–µ–ø—Ç–æ–≤.csv'))
    
    # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ pandas –¥–æ–±–∞–≤–∏–ª —Å—É—Ñ—Ñ–∏–∫—Å
    if 'id_–ø–∞—Ü–∏–µ–Ω—Ç–∞.1' in df_recipes.columns:
        df_recipes = df_recipes.rename(columns={'id_–ø–∞—Ü–∏–µ–Ω—Ç–∞': 'id_—Ä–µ—Ü–µ–ø—Ç–∞', 'id_–ø–∞—Ü–∏–µ–Ω—Ç–∞.1': 'id_–ø–∞—Ü–∏–µ–Ω—Ç–∞_fk'})
    else:
        # –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–∞–∑–≤–∞–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã, –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–æ–ª–æ–Ω–∫—É –∫–∞–∫ FK (—Å—É–¥—è –ø–æ —Ç–≤–æ–µ–º—É –æ–ø–∏—Å–∞–Ω–∏—é)
        # –ù–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –∫–æ–ª–æ–Ω–∫–∞ - —ç—Ç–æ –ø–∞—Ü–∏–µ–Ω—Ç
        cols = list(df_recipes.columns)
        df_recipes = df_recipes.rename(columns={cols[0]: 'id_—Ä–µ—Ü–µ–ø—Ç–∞', cols[-1]: 'id_–ø–∞—Ü–∏–µ–Ω—Ç–∞_fk'})

    print(f"   - –î–∏–∞–≥–Ω–æ–∑—ã: {df_diag.shape}")
    print(f"   - –ü–∞—Ü–∏–µ–Ω—Ç—ã: {df_patients.shape}")
    print(f"   - –†–µ—Ü–µ–ø—Ç—ã: {df_recipes.shape}")
    
    return df_diag, df_patients, df_recipes

def process_data(df_diag, df_patients, df_recipes):
    print("‚öôÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü...")

    # 1. –ü—Ä–∏–≤–æ–¥–∏–º –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è –∫ —Å—Ç—Ä–æ–∫–∞–º –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ —Å–ª–∏—è–Ω–∏—è
    df_recipes['id_–ø–∞—Ü–∏–µ–Ω—Ç–∞_fk'] = df_recipes['id_–ø–∞—Ü–∏–µ–Ω—Ç–∞_fk'].astype(str)
    df_patients['id_–ø–∞—Ü–∏–µ–Ω—Ç–∞'] = df_patients['id_–ø–∞—Ü–∏–µ–Ω—Ç–∞'].astype(str)
    
    # 2. –ú–ï–†–î–ñ: –†–µ—Ü–µ–ø—Ç—ã + –ü–∞—Ü–∏–µ–Ω—Ç—ã (—á—Ç–æ–±—ã –∑–Ω–∞—Ç—å –†–∞–π–æ–Ω)
    merged = df_recipes.merge(
        df_patients[['id_–ø–∞—Ü–∏–µ–Ω—Ç–∞', '—Ä–∞–π–æ–Ω_–ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è', '–ø–æ–ª', '–¥–∞—Ç–∞_—Ä–æ–∂–¥–µ–Ω–∏—è']], 
        left_on='id_–ø–∞—Ü–∏–µ–Ω—Ç–∞_fk', 
        right_on='id_–ø–∞—Ü–∏–µ–Ω—Ç–∞', 
        how='left'
    )
    
    # 3. –ú–ï–†–î–ñ: + –î–∏–∞–≥–Ω–æ–∑—ã (—á—Ç–æ–±—ã –∑–Ω–∞—Ç—å –ù–∞–∑–≤–∞–Ω–∏–µ –±–æ–ª–µ–∑–Ω–∏)
    # –í —Ä–µ—Ü–µ–ø—Ç–∞—Ö '–∫–æ–¥_–¥–∏–∞–≥–Ω–æ–∑–∞', –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ '–∫–æ–¥_–º–∫–±'
    merged = merged.merge(
        df_diag[['–∫–æ–¥_–º–∫–±', '–Ω–∞–∑–≤–∞–Ω–∏–µ_–¥–∏–∞–≥–Ω–æ–∑–∞', '–∫–ª–∞—Å—Å_–∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è']],
        left_on='–∫–æ–¥_–¥–∏–∞–≥–Ω–æ–∑–∞',
        right_on='–∫–æ–¥_–º–∫–±',
        how='left'
    )
    
    # 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç
    merged['–¥–∞—Ç–∞_—Ä–µ—Ü–µ–ø—Ç–∞'] = pd.to_datetime(merged['–¥–∞—Ç–∞_—Ä–µ—Ü–µ–ø—Ç–∞'], errors='coerce')
    merged['–º–µ—Å—è—Ü'] = merged['–¥–∞—Ç–∞_—Ä–µ—Ü–µ–ø—Ç–∞'].dt.month_name()
    merged['—Å–µ–∑–æ–Ω'] = merged['–¥–∞—Ç–∞_—Ä–µ—Ü–µ–ø—Ç–∞'].dt.month.map({
        12: '–ó–∏–º–∞', 1: '–ó–∏–º–∞', 2: '–ó–∏–º–∞',
        3: '–í–µ—Å–Ω–∞', 4: '–í–µ—Å–Ω–∞', 5: '–í–µ—Å–Ω–∞',
        6: '–õ–µ—Ç–æ', 7: '–õ–µ—Ç–æ', 8: '–õ–µ—Ç–æ',
        9: '–û—Å–µ–Ω—å', 10: '–û—Å–µ–Ω—å', 11: '–û—Å–µ–Ω—å'
    })

    # –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ –Ω–µ –Ω–∞—à–ª–∏—Å—å —Å–≤—è–∑–∏ (–µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –±–∏—Ç—ã–µ)
    merged = merged.dropna(subset=['—Ä–∞–π–æ–Ω_–ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è', '–∫–ª–∞—Å—Å_–∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è'])
    
    print(f"   - –ò—Ç–æ–≥–æ–≤—ã–π –¥–∞—Ç–∞—Å–µ—Ç: {merged.shape[0]} –∑–∞–ø–∏—Å–µ–π")
    return merged

def generate_insights(df):
    print("üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JSON-–∏–Ω—Å–∞–π—Ç–æ–≤...")

    # --- –ò–ù–°–ê–ô–¢ 1: –¢–æ–ø –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –ø–æ –†–∞–π–æ–Ω–∞–º ---
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º: –†–∞–π–æ–Ω -> –ö–ª–∞—Å—Å –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è -> –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
    district_stats = (
        df.groupby(['—Ä–∞–π–æ–Ω_–ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è', '–∫–ª–∞—Å—Å_–∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è'])
        .size()
        .reset_index(name='count')
        .sort_values(['—Ä–∞–π–æ–Ω_–ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è', 'count'], ascending=[True, False])
    )
    
    # –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ –≤–ª–æ–∂–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ê–≥–µ–Ω—Ç–∞
    # { "–ê–¥–º–∏—Ä–∞–ª—Ç–µ–π—Å–∫–∏–π": {"–ë–æ–ª–µ–∑–Ω–∏ –æ—Ä–≥–∞–Ω–æ–≤ –¥—ã—Ö–∞–Ω–∏—è": 120, ...}, ... }
    district_json = {}
    for district in district_stats['—Ä–∞–π–æ–Ω_–ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è'].unique():
        subset = district_stats[district_stats['—Ä–∞–π–æ–Ω_–ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è'] == district].head(5) # –ë–µ—Ä–µ–º —Ç–æ–ø-5 –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏
        district_json[district] = dict(zip(subset['–∫–ª–∞—Å—Å_–∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è'], subset['count']))

    with open(os.path.join(OUTPUT_DIR, 'stats_by_district.json'), 'w', encoding='utf-8') as f:
        json.dump(district_json, f, ensure_ascii=False, indent=2)

    # --- –ò–ù–°–ê–ô–¢ 2: –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å ---
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º: –°–µ–∑–æ–Ω -> –ö–ª–∞—Å—Å –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è -> –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
    season_stats = (
        df.groupby(['—Å–µ–∑–æ–Ω', '–∫–ª–∞—Å—Å_–∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è'])
        .size()
        .reset_index(name='count')
        .sort_values(['—Å–µ–∑–æ–Ω', 'count'], ascending=[True, False])
    )
    
    season_json = {}
    for season in season_stats['—Å–µ–∑–æ–Ω'].unique():
        subset = season_stats[season_stats['—Å–µ–∑–æ–Ω'] == season].head(5)
        season_json[season] = dict(zip(subset['–∫–ª–∞—Å—Å_–∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è'], subset['count']))

    with open(os.path.join(OUTPUT_DIR, 'stats_by_season.json'), 'w', encoding='utf-8') as f:
        json.dump(season_json, f, ensure_ascii=False, indent=2)
        
    print("‚úÖ –ì–æ—Ç–æ–≤–æ! –§–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–ø–∫—É 'output/'.")

if __name__ == "__main__":
    df_diag, df_patients, df_recipes = load_data()
    merged_df = process_data(df_diag, df_patients, df_recipes)
    generate_insights(merged_df)